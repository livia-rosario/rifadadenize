<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin 2 - Confirmação Manual</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body style="font-family: 'Poppins', sans-serif; background: var(--background); padding: 2rem;">
  <h1 class="admin-h1" style="text-align: center; margin-bottom: 2rem;">✅ Confirmação Manual de Reservas</h1>

  <div class="admin-table-container" style="background: var(--white); padding: 2rem; border-radius: 1rem;">
    <h2 style="margin-bottom: 1rem;">Reservas pendentes ou canceladas</h2>
    <div id="tabelaReservas">Carregando...</div>
  </div>

<script type="module">
const supabaseUrl = 'https://kkxypfqqndnexpzpkgch.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtreHlwZnFxbmRuZXhwenBrZ2NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDM3NDgsImV4cCI6MjA3NTQ3OTc0OH0.hpUzqjo2F022omCsXCx8f0NwOtGnE_zr46xNdhMGr34';
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let todasReservas = [];

async function carregarDados() {
  const { data: reservas, error } = await supabaseClient
    .from('reservas')
    .select('*')
    .in('status', ['aguardando', 'cancelada'])  // ← MOSTRA CANCELADA TAMBÉM
    .order('criado_em', { ascending: false });

  if (error) {
    document.getElementById('tabelaReservas').innerHTML = 'Erro ao carregar reservas.';
    return;
  }

  // Se não houver
  if (!reservas || reservas.length === 0) {
    document.getElementById('tabelaReservas').innerHTML = '<p style="text-align:center;color:gray;">Nenhuma reserva pendente.</p>';
    return;
  }

  todasReservas = reservas;
  renderizarTabela();
}

function renderizarTabela() {
  const linha = todasReservas.map(res => {
    const numeros = Array.isArray(res.numeros) ? res.numeros : JSON.parse(res.numeros);
    const total = numeros.length * 10; // valor do número

    const botoesAcoes = res.status === 'aguardando'
      ? `
          <button class="btn-confirmar" style="margin-right: .5rem;"
            onclick="confirmarReserva('${res.id}', ${JSON.stringify(numeros)})">Confirmar</button>
          <button class="btn-cancelar"
            onclick="cancelarReserva('${res.id}', ${JSON.stringify(numeros)})">Cancelar</button>
        `
      : `<span style="color: var(--red-dark); font-weight: 600;">Cancelada</span>`;

    const classeLinha = res.status === 'cancelada' ? 'style="opacity:.6;"' : '';

    return `
      <tr ${classeLinha}>
        <td>${res.nome}</td>
        <td>${res.whatsapp || '-'}</td>
        <td>${numeros.join(', ')}</td>
        <td>R$ ${total.toFixed(2)}</td>
        <td>${botoesAcoes}</td>
      </tr>
    `;
  }).join('');

  document.getElementById('tabelaReservas').innerHTML = `
    <table class="admin-table">
      <thead>
        <tr>
          <th>Nome</th>
          <th>WhatsApp</th>
          <th>Números</th>
          <th>Total</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>${linha}</tbody>
    </table>
  `;
}

window.confirmarReserva = async function(id, numeros) {
  await supabaseClient.from('reservas').update({ status: 'confirmado' }).eq('id', id);
  await supabaseClient.from('numeros').update({ status: 'pago' }).in('id', numeros);

  // grava para aparecer no painel admin
  const { data: reserva } = await supabaseClient.from('reservas').select('nome').eq('id', id).single();
  const inserts = numeros.map(n => ({ reserva_id: id, numero: n, nome_exibido: reserva.nome }));

  await supabaseClient.from('numeros_comprados').insert(inserts, { ignoreDuplicates: true });

  carregarDados();
};

window.cancelarReserva = async function(id, numeros) {
  await supabaseClient.from('reservas').update({ status: 'cancelada' }).eq('id', id);
  await supabaseClient.from('numeros').update({ status: 'livre', reserva_id: null }).in('id', numeros);
  await supabaseClient.from('numeros_comprados').delete().eq('reserva_id', id);

  carregarDados();
};

carregarDados();
setInterval(carregarDados, 10000);
</script>

</body>
</html>
